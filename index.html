<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>
	  Slime Volleyball
	</title>
	<script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
    <script language="javascript" src="script/classes.js" type="text/javascript"></script>
	<script language="javascript" src="script/jquery.hotkeys.js" type="text/javascript"></script>
	<script language="javascript" src="script/key_status.js" type="text/javascript"></script>
 </head>
  <body>
    <script type='text/javascript'>
	  //constants
      var CANVAS_WIDTH = 800;
	  var CANVAS_HEIGHT = 350;
	  var GROUND_HEIGHT = 75;
	  var MOVE_SPEED = 10;
	  
	  //create and append the canvas
	  var canvasElement = $("<canvas id='canvas' width='" + CANVAS_WIDTH + "'height='" + CANVAS_HEIGHT + "'></canvas>");
	  var canvas = canvasElement.get(0).getContext("2d");
	  canvasElement.appendTo('body');
	  
	  //game loop
	  var FPS = 30;
	  setInterval(function() {
	    update();
		draw();
	  }, 1000/FPS);
	  

      //create the objects
	  var human = new Slime('yellow', 200, CANVAS_HEIGHT - GROUND_HEIGHT);
	  var enemy = new Slime('white', 600, CANVAS_HEIGHT - GROUND_HEIGHT);
	  var ball = new Ball('yellow', 200, 100);
	  var sky = new Sky(CANVAS_HEIGHT, CANVAS_WIDTH);
	  var ground = new Ground(CANVAS_HEIGHT, CANVAS_WIDTH, GROUND_HEIGHT);
	  var net = new Net(CANVAS_HEIGHT, CANVAS_WIDTH, GROUND_HEIGHT);
	  
	  
	  function update() {
	    if (keydown.a) {
		  human.x -=MOVE_SPEED;
		}
		if (keydown.d) {
		  human.x +=MOVE_SPEED;
		}
		if (keydown.w) {
		  human.jump();
		}
		
		if (human.jumping) {
		  human.jumpTimer -=1;
		  if (human.jumpTimer == 0) {
		    human.jumping = false;
		  }
		  human.y -=MOVE_SPEED*2;
		}
		
		if (ball.bouncing) {
		  ball.bounceTimer -=1;
		  if (ball.bounceTimer == 0) {
		    ball.bouncing = false;
		  }
		  ball.y -=MOVE_SPEED*2;
		}
		
		ball.y +=MOVE_SPEED;
		human.y +=MOVE_SPEED;
        enemy.y +=MOVE_SPEED;
		
		human.x = human.x.clamp(0 + human.radius, net.x - human.radius);
		enemy.x = enemy.x.clamp(net.x + net.width + enemy.radius, CANVAS_WIDTH - enemy.radius);
		
		human.y = human.y.clamp(0, CANVAS_HEIGHT - GROUND_HEIGHT);
		enemy.y = enemy.y.clamp(0, CANVAS_HEIGHT - GROUND_HEIGHT);
		ball.y = ball.y.clamp(0, CANVAS_HEIGHT - GROUND_HEIGHT - ball.radius);
		
		handleCollisions();
	  }
	  
	  function draw() {
	    canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
		sky.draw();
		ground.draw();
		net.draw();
	    human.draw();
		enemy.draw();
		ball.draw();
	  }
	  
	  Number.prototype.clamp = function(min, max) {
	    return Math.min(Math.max(this, min), max);
	  }
	  
	  function handleCollisions() {
	    if (ballGroundCollision(ball, ground)) {
		  ball.bounce();
		  //console.log('ball ground');
		}
		if (circleCollision(ball, human)) {
		  ball.bounce();
		  //console.log('ball human');
		}
		if (collides(ball, enemy)) {
		  ball.bounce();
		  //console.log('ball enemy');
		}
	  }
	  
	  function circleCollision(a, b) {
	    return Math.sqrt(Math.pow(Math.abs(a.x - b.x),2) + Math.pow(Math.abs(a.y - b.y),2)) <= a.radius + b.radius;
	  }
	  
	  function ballGroundCollision(b, g) {
	    return (b.y + b.height >= g.y)
	  }
	  
	  //rectangle collision algorithm
	  function collides(a, b) {
        return a.x <= b.x + b.width &&
         a.x + a.width >= b.x &&
         a.y <= b.y + b.height &&
         a.y + a.height >= b.y;
      }

	</script>
  </body>
</html>